Create database cki;
use cki;

create  table KHACHHANG(
	MAKH varchar(20) primary key,
	TENKH varchar(50),
	DIACHI varchar(70),
	SDT varchar(15),
	LOAIKH varchar (10)

);

create table LOAIKHACHHANG(
	LOAIKH varchar(10) primary key,
	MOTALOAIKHACHHANG varchar(50)
);

create table MONAN(
	MAMA varchar(10) primary key,
	TENMA varchar(20),
	MOTAMA varchar(50), 
	SLNguoiMin int,
	SLNguoiMax int,
	DonGia money,
	DVT varchar(20)
);

create table DAT_NAU_AN(
	MADATNAU varchar(50) primary key,
	MAKH varchar(20),
	TGBatDau Datetime,
	TGKetThuc Datetime,
	LOAIDV varchar(20),
	GHICHU varchar(50),
	TRANGTHAI varchar(50)
);

create table CTDATNAUAN(
	MADATNAU varchar(50) primary key,
	MAMA varchar(10),
	SOLUONG int,
	GHICHUCHITIET varchar(50)
);

create table LOAIDICHVU(
	LOAIDV varchar(20) primary key,
	MOTADV varchar(50)
);

INSERT INTO KHACHHANG VALUES('KH0001', 'Nguyen Van A', 'Hoa Chau', '0905426587', 'L1')
INSERT INTO KHACHHANG VALUES('KH0002', 'Tran Van B', 'Hai Son', '0165892221', 'L2')
INSERT INTO KHACHHANG VALUES('KH0003', 'Nguyen Van C', 'Son Tra', '0935254789', 'L3')
INSERT INTO KHACHHANG VALUES('KH0004', 'Tran Thi D', 'Lien Chieu', '0932544154', 'L1')
select * from khachhang

INSERT INTO LOAIKHACHHANG VALUES('L1', 'Ca nhan')
INSERT INTO LOAIKHACHHANG VALUES('L2', 'Doanh nghiep')
INSERT INTO LOAIKHACHHANG VALUES('L3', 'Co quan doan the')

INSERT INTO MONAN VALUES ('MA0001', 'Bia', 'Sai gon, Larue, Tiger', NULL, NULL, 200000, 'Thung')
INSERT INTO MONAN VALUES ('MA0002', 'Lau', 'Lau thai', 5, 10, 150000, 'Noi')
INSERT INTO MONAN VALUES ('MA0003', 'Goi bo', 'Goi bo', 5, 20, 100000, 'Dia')
select * from MONAN

set dateformat dmy
INSERT INTO DAT_NAU_AN VALUES ('DN0001', 'KH0001', '10/08/2017', '10/8/2017', 'DV01', 'Den som truoc 30 phut', 'Chua xac nhan')
INSERT INTO DAT_NAU_AN VALUES ('DN0002', 'KH0002', '20/10/2017', '20/10/2017', 'DV02', 'Cam hoa don VAT', 'Da xac nhan')
INSERT INTO DAT_NAU_AN VALUES ('DN0003', 'KH0003', '31/12/2017', '31/12/2017', 'DV03', 'Cam hoa don VAT', 'Huy')
SELECT * FROM DAT_NAU_AN

INSERT INTO LOAIDICHVU VALUES ('DV01', 'Nau thue')
INSERT INTO LOAIDICHVU VALUES ('DV02', 'Nau su kien')
INSERT INTO LOAIDICHVU VALUES ('DV03', 'Nau dinh ky')

INSERT INTO CTDATNAUAN VALUES ('DN0001', 'MA0001', 12, 'Uop lanh truoc khi dung')
INSERT INTO CTDATNAUAN VALUES ('DN0002', 'MA0002', 24, 'Them nhieu ot')
INSERT INTO CTDATNAUAN VALUES ('DN0003', 'MA0003', 36, 'Vat chanh truoc khi an 10 phut')


/* SQL */

/* A */
SELECT *
FROM KHACHHANG KH
WHERE KH.TENKH NOT LIKE '%G' AND KH.TENKH NOT LIKE '%M' AND LEN(KH.TENKH) >= 30 

/* B */
SELECT DNA.MADATNAU, KH.TENKH, DNA.TGBatDau, DNA.TGKetThuc, DNA.LOAIDV, DNA.TRANGTHAI
FROM (LOAIDICHVU LDV JOIN DAT_NAU_AN DNA ON LDV.LOAIDV = DNA.LOAIDV)
	JOIN KHACHHANG KH ON DNA.MAKH = KH.MAKH
WHERE LDV.MOTADV = 'Nau su kien' AND DNA.TGBatDau >= '01/01/2018' AND DNA.TGBatDau <= '31/1/2018'

/* C */
SELECT DNA.MADATNAU, KH.TENKH, KH.DIACHI, DNA.TGBatDau, DNA.TGKetThuc, DNA.LOAIDV, DNA.TRANGTHAI, MA.TENMA, CTDNA.SOLUONG, MA.DonGia
FROM ((DAT_NAU_AN DNA JOIN CTDATNAUAN CTDNA ON DNA.MADATNAU = CTDNA.MADATNAU)
		JOIN KHACHHANG KH ON DNA.MAKH = KH.MAKH) JOIN MONAN MA ON CTDNA.MAMA = MA.MAMA
WHERE DNA.TRANGTHAI = 'Huy'


/* D */
SELECT KH.*
FROM KHACHHANG KH JOIN LOAIKHACHHANG LKH ON KH.LOAIKH = LKH.LOAIKH
WHERE LKH.MOTALOAIKHACHHANG = 'Ca nhan' AND KH.MAKH IN(
														SELECT DNA.MAKH
														FROM DAT_NAU_AN DNA 
														WHERE YEAR(DNA.TGBatDau) = 2018)

/* E */
/* C1 */
SELECT DISTINCT KH.TENKH
FROM KHACHHANG KH 
WHERE KH.DIACHI = 'Son Tra'

/* C2 */
SELECT KH.TENKH
FROM KHACHHANG KH
WHERE KH.DIACHI = 'Son Tra'
GROUP BY KH.TENKH


/* F */
SELECT DNA.MADATNAU, KH.MAKH, KH.TENKH, KH.DIACHI, DNA.TGBatDau, DNA.TGKetThuc, CTDNA.MAMA, CTDNA.SOLUONG, MA.DonGia, MA.DVT
FROM ((KHACHHANG KH LEFT JOIN DAT_NAU_AN DNA ON DNA.MAKH = KH.MAKH)
	LEFT JOIN CTDATNAUAN CTDNA ON DNA.MADATNAU = CTDNA.MADATNAU) 
		LEFT JOIN MONAN MA ON CTDNA.MAMA = MA.MAMA

/* G */
SELECT KH.MAKH, KH.TENKH
FROM KHACHHANG KH
WHERE KH.DIACHI = 'Son Tra' AND KH.MAKH IN(
											SELECT DNA.MAKH
											FROM DAT_NAU_AN DNA JOIN CTDATNAUAN CTDNA ON DNA.MADATNAU = CTDNA.MADATNAU
											GROUP BY DNA.MAKH
											HAVING COUNT(DISTINCT CTDNA.MAMA) = 10)